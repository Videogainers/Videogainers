<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videogainers Traits Finder</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <link href="style.css" rel="stylesheet">

    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/drilldown.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

</head>

<body>
    <nav class="navbar navbar-dark bg-dark fixed-top text-light">
        <div class="container-fluid me-4 ms-3">
            <div class="ml-5">
                <a class="navbar-brand unselectable" href="https://videogainers.github.io/">
                    VideoGainerS
                </a>
            </div>
            <div class="navbar-nav flex-row gap-4">
                <svg onclick="window.open('https://discord.gg/TpHadjeMcq', '_blank')" height="30px"
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" role="img" focusable="false">
                    <title>Discord Server</title>
                    <path
                        d="M13.545 2.907a13.227 13.227 0 0 0-3.257-1.011.05.05 0 0 0-.052.025c-.141.25-.297.577-.406.833a12.19 12.19 0 0 0-3.658 0 8.258 8.258 0 0 0-.412-.833.051.051 0 0 0-.052-.025c-1.125.194-2.22.534-3.257 1.011a.041.041 0 0 0-.021.018C.356 6.024-.213 9.047.066 12.032c.001.014.01.028.021.037a13.276 13.276 0 0 0 3.995 2.02.05.05 0 0 0 .056-.019c.308-.42.582-.863.818-1.329a.05.05 0 0 0-.01-.059.051.051 0 0 0-.018-.011 8.875 8.875 0 0 1-1.248-.595.05.05 0 0 1-.02-.066.051.051 0 0 1 .015-.019c.084-.063.168-.129.248-.195a.05.05 0 0 1 .051-.007c2.619 1.196 5.454 1.196 8.041 0a.052.052 0 0 1 .053.007c.08.066.164.132.248.195a.051.051 0 0 1-.004.085 8.254 8.254 0 0 1-1.249.594.05.05 0 0 0-.03.03.052.052 0 0 0 .003.041c.24.465.515.909.817 1.329a.05.05 0 0 0 .056.019 13.235 13.235 0 0 0 4.001-2.02.049.049 0 0 0 .021-.037c.334-3.451-.559-6.449-2.366-9.106a.034.034 0 0 0-.02-.019Zm-8.198 7.307c-.789 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.45.73 1.438 1.613 0 .888-.637 1.612-1.438 1.612Zm5.316 0c-.788 0-1.438-.724-1.438-1.612 0-.889.637-1.613 1.438-1.613.807 0 1.451.73 1.438 1.613 0 .888-.631 1.612-1.438 1.612Z"
                        fill="#FFFFFF"></path>
                </svg>
                <svg onclick="window.open('https://www.facebook.com/groups/982310415898367/', '_blank')" height="30px"
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" role="img" focusable="false">
                    <title>Facebook Group</title>
                    <path fill="#FFFFFF"
                        d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z" />
                </svg>
                <svg onclick="window.open('https://t.me/+5UYh7zWHcIY2ZDI8', '_blank')" height="30px"
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512">
                    <title>Telegram Channel</title>
                    <path fill="#FFFFFF"
                        d="M248,8C111.033,8,0,119.033,0,256S111.033,504,248,504,496,392.967,496,256,384.967,8,248,8ZM362.952,176.66c-3.732,39.215-19.881,134.378-28.1,178.3-3.476,18.584-10.322,24.816-16.948,25.425-14.4,1.326-25.338-9.517-39.287-18.661-21.827-14.308-34.158-23.215-55.346-37.177-24.485-16.135-8.612-25,5.342-39.5,3.652-3.793,67.107-61.51,68.335-66.746.153-.655.3-3.1-1.154-4.384s-3.59-.849-5.135-.5q-3.283.746-104.608,69.142-14.845,10.194-26.894,9.934c-8.855-.191-25.888-5.006-38.551-9.123-15.531-5.048-27.875-7.717-26.8-16.291q.84-6.7,18.45-13.7,108.446-47.248,144.628-62.3c68.872-28.647,83.183-33.623,92.511-33.789,2.052-.034,6.639.474,9.61,2.885a10.452,10.452,0,0,1,3.53,6.716A43.765,43.765,0,0,1,362.952,176.66Z" />
                </svg>
                <svg onclick="window.open('https://www.instagram.com/videogain3rs/', '_blank')" height="30px"
                    xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512">
                    <title>Instagram Profile</title>
                    <path fill="#FFFFFF"
                        d="M224.1 141c-63.6 0-114.9 51.3-114.9 114.9s51.3 114.9 114.9 114.9S339 319.5 339 255.9 287.7 141 224.1 141zm0 189.6c-41.1 0-74.7-33.5-74.7-74.7s33.5-74.7 74.7-74.7 74.7 33.5 74.7 74.7-33.6 74.7-74.7 74.7zm146.4-194.3c0 14.9-12 26.8-26.8 26.8-14.9 0-26.8-12-26.8-26.8s12-26.8 26.8-26.8 26.8 12 26.8 26.8zm76.1 27.2c-1.7-35.9-9.9-67.7-36.2-93.9-26.2-26.2-58-34.4-93.9-36.2-37-2.1-147.9-2.1-184.9 0-35.8 1.7-67.6 9.9-93.9 36.1s-34.4 58-36.2 93.9c-2.1 37-2.1 147.9 0 184.9 1.7 35.9 9.9 67.7 36.2 93.9s58 34.4 93.9 36.2c37 2.1 147.9 2.1 184.9 0 35.9-1.7 67.7-9.9 93.9-36.2 26.2-26.2 34.4-58 36.2-93.9 2.1-37 2.1-147.8 0-184.8zM398.8 388c-7.8 19.6-22.9 34.7-42.6 42.6-29.5 11.7-99.5 9-132.1 9s-102.7 2.6-132.1-9c-19.6-7.8-34.7-22.9-42.6-42.6-11.7-29.5-9-99.5-9-132.1s-2.6-102.7 9-132.1c7.8-19.6 22.9-34.7 42.6-42.6 29.5-11.7 99.5-9 132.1-9s102.7-2.6 132.1 9c19.6 7.8 34.7 22.9 42.6 42.6 11.7 29.5 9 99.5 9 132.1s2.7 102.7-9 132.1z" />
                </svg>
                <svg onclick="window.open('https://www.youtube.com/c/VideoGainers?sub_confirmation=1', '_blank')"
                    height="30px" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512">
                    <title>Youtube Channel</title>
                    <path fill="#FFFFFF"
                        d="M549.655 124.083c-6.281-23.65-24.787-42.276-48.284-48.597C458.781 64 288 64 288 64S117.22 64 74.629 75.486c-23.497 6.322-42.003 24.947-48.284 48.597-11.412 42.867-11.412 132.305-11.412 132.305s0 89.438 11.412 132.305c6.281 23.65 24.787 41.5 48.284 47.821C117.22 448 288 448 288 448s170.78 0 213.371-11.486c23.497-6.321 42.003-24.171 48.284-47.821 11.412-42.867 11.412-132.305 11.412-132.305s0-89.438-11.412-132.305zm-317.51 213.508V175.185l142.739 81.205-142.739 81.201z" />
                </svg>
            </div>
        </div>
    </nav>
    <div class="skip-nav container-fluid">
        <div class="row gap-3 justify-content-center">
            <div class="panel-container">
                <div class="card">
                    <div class="card-header">
                        <h5>Filters</h5>
                    </div>
                    <div class="card-body pt-3">
                        <h6 class="card-subtitle text-muted">
                            <label for="hat">
                                HAT
                            </label>
                        </h6>
                        <select id="hat" class="form-select mt-1 mb-3"></select>
                        <div class="w-100 d-flex justify-content-evenly">
                            <input id="btn_cross_search" type="checkbox" class="btn-check" autocomplete="off" checked>
                            <label class="btn btn-outline-dark w-25" for="btn_cross_search">
                                <i class="fa fa-search-plus fa-lg"></i>
                            </label>

                            <button id="btn_exchange" class="btn btn-outline-dark w-25"><i
                                    class="fa fa-exchange fa-lg"></i></button>
                        </div>
                        <h6 class="card-subtitle text-muted mt-1">
                            <label for="Torso">
                                TORSO
                            </label>
                        </h6>
                        <select id="torso" class="form-select mt-1"></select>
                        <div id="rarity_checkboxes" class="form-check-inline d-flex justify-content-between mt-4">
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-between p-4 w-100">
                        <button id="btn_reset" class="btn btn-outline-danger">RESET</button>
                        <button id="btn_search" class="btn btn-outline-dark">SEARCH</button>
                    </div>
                </div>
            </div>
            <div class="panel-container">
                <div class="card h-100">
                    <div class="card-body p-0">
                        <div class="d-flex align-items-center justify-content-center h-100" id="pie_chart_container">
                            <h4>Waiting For A Search</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="row">
            <div id="result" class="row mt-4 justify-content-center"></div>
            <div id="error_msg" class="row mt-4 justify-content-center"></div>
        </div>
    </div>
    <script>
        (() => {
            const build_select = (dom_parent_element, children) => {
                for (const child of children) {
                    const option = document.createElement('option');
                    option.value = child;
                    option.text = child;
                    dom_parent_element.appendChild(option);
                }
            };

            const build_checkbox = (dom_parent_element, children, group_name, checked = true) => {
                for (const child of children) {
                    const div = document.createElement('div');

                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.id = child;
                    input.name = group_name;
                    input.value = child;
                    input.checked = checked;
                    input.autocomplete = "off";
                    input.classList.add('btn-check');

                    const label = document.createElement('label');
                    label.htmlFor = child;
                    label.innerText = child.toUpperCase();
                    label.classList.add('btn-outline-dark');
                    label.classList.add('btn-check-custom');

                    div.appendChild(input);
                    div.appendChild(label);

                    input.onclick = function (e) {
                        this.blur();
                    };

                    dom_parent_element.appendChild(div);
                }
            };

            const build_traits_map = traits => {
                const traits_map = {};

                for (const trait of traits) {
                    traits_map[trait] = {};
                }

                return traits_map;
            };

            const traits = ['', 'Adventurer', 'Artistic', 'Authoritarian', 'Brave', 'Cleptomaniac', 'Clever', 'Clumsy', 'Commanding', 'Cooker', 'Cultural', 'Dancer',
                'Driver', 'Drunk', 'Faithful', 'Fanatical', 'Fancy', 'Fatigued', 'Foodie', 'Forgetful', 'Friendly', 'Greedy', 'Heroic', 'Historical', 'Imposing',
                'Impulsive', 'Insomniac', 'Joyful', 'Lawful', 'Legendary', 'Magical', 'Manipulative', 'Musical', 'Nimble', 'Outdoorsy', 'Scholar', 'Server', 'Shady', 'Short Tempered',
                'Slow', 'Smelly', 'Smug', 'Sporty', 'Star', 'Storyteller', 'Stressed', 'Stubborn', 'Unfaithful', 'Uniformed', 'Unreliable', 'Weirdo', 'Workaholic'
            ];

            const rarity = ['common', 'rare', 'epic', 'legendary'];

            const checkbox_group = 'rarity';
            const hat = document.getElementById("hat");
            const torso = document.getElementById("torso");
            const result = document.getElementById("result");
            const error = document.getElementById("error_msg");
            const rarity_cbs = document.getElementById("rarity_checkboxes");
            const btn_search = document.getElementById("btn_search");
            const btn_reset = document.getElementById("btn_reset");
            const btn_exchange = document.getElementById("btn_exchange");
            const btn_cross_search = document.getElementById("btn_cross_search");

            build_select(hat, traits);
            build_select(torso, traits);
            build_checkbox(rarity_cbs, rarity, checkbox_group, true);

            const rarity_cbs_list = document.getElementsByName(checkbox_group);

            const get_checked_rarities = checkbox_list => {
                return Array.from(checkbox_list).filter(cb => cb.checked).map(cb => `"${cb.value}"`);
            };

            const set_all_checkbox = (checkbox_list, checked = true) => {
                Array.from(checkbox_list).map(cb => cb.checked = checked);
            };

            btn_search.onclick = () => {
                const domain = `https://marketplace.api.mousehaunt.com/orders/search?asset_type=mouse&rarities=[${encodeURIComponent(get_checked_rarities(rarity_cbs_list))}]+&status=open&offset=0&limit=99999999999&price_order=asc`;
                search(domain, hat.value.trim().toLowerCase(), torso.value.trim().toLowerCase());
            };

            btn_exchange.onclick = () => {
                const hat_value = hat.value;
                hat.value = torso.value;
                torso.value = hat_value;
            };

            btn_reset.onclick = () => {
                result.innerHTML = '';
                error.innerHTML = '';
                hat.value = '';
                torso.value = '';
                set_all_checkbox(rarity_cbs_list, true);
            };

            btn_cross_search.onchange = function (e) {
                this.blur();
            };


            const print_result = filtered_rats => {
                if (!filtered_rats.length) {
                    result.innerHTML = 'No Rat Found';
                    return;
                }

                result.innerHTML = filtered_rats.map(rat =>
                    `<div class="card rat-card">
                        <img loading="lazy" class="rat-img" src="${rat.image_url}" alt="Mouse ${rat.id}">
                        <div class="container">
                            <h5><b>NFT ID: <a href="https://mousehaunt.com/marketplace/orders/${rat.id}" target="blank">${rat.nft_id}</a></b></h5>
                            <h5><b>RARITY: ${rat.rarity}</b></h5> 
                            <h6>${rat.traits.filter(traits => traits.display_type == 'outfit').map(traits => traits.value)}</h6> 
                            <h5><b>PRICE: ${(rat.price_in_wei * 1e-18).toFixed(2)}</b> MHT</h5> 
                        </div>
                    </div>`
                );
            };

            const search = (url, hat, torso) => {
                result.innerHTML = 'Loading...';
                error.innerHTML = '';

                const traits_map = build_traits_map(traits);

                fetch(url).then(response => {
                    return response.json();
                }).then(data => {
                    const filtered_rats = data.results.filter(rat => {
                        fill_traits_map(rat, traits_map);
                        const [hat_check, torso_check] = check_traits_conditions(hat, torso, rat);
                        return hat_check && torso_check;
                    });

                    const chart_traits_pie = build_and_fill_pie_chart(traits_map);
                    print_result(filtered_rats);
                }).catch(err => {
                    console.error(err);
                    error.innerHTML = '<h4 class="d-flex align-items-center justify-content-center">The mice ate too much cheese! </br> They\'ll be back after a siesta!</h4>';
                    result.innerHTML = '';
                });
            };

            const check_traits_conditions = (hat, torso, rat) => {
                let hat_check = true;
                let torso_check = true;

                if (hat.length && torso.length && hat == torso) {
                    torso_check = rat.traits.filter(trait => trait.display_type == 'outfit' && trait.value.toLowerCase() == torso).length == 2;
                }
                else if (btn_cross_search.checked) {
                    hat_check = !hat.length || rat.traits.some(trait => trait.display_type == 'outfit' && trait.value.toLowerCase() == hat);
                    torso_check = !torso.length || rat.traits.some(trait => trait.display_type == 'outfit' && trait.value.toLowerCase() == torso);
                } else {
                    hat_check = !hat.length || rat.traits.some(trait => trait.display_type == 'outfit' && trait.trait_type == 'Hat' && trait.value.toLowerCase() == hat);
                    torso_check = !torso.length || rat.traits.some(trait => trait.display_type == 'outfit' && trait.trait_type == 'Torso' && trait.value.toLowerCase() == torso);
                }

                return [hat_check, torso_check];
            };

            const fill_traits_map = (rat, traits_map) => {
                const outfit = rat.traits.filter(trait => trait.display_type == "outfit");

                try {
                    switch (outfit.length) {
                        case 0:
                            !traits_map[""].hasOwnProperty("") && (traits_map[""][""] = 0);
                            traits_map[""][""] += 1;
                            break;
                        case 1:
                            !traits_map[outfit[0].value].hasOwnProperty(outfit[0].value) && (traits_map[outfit[0].value][outfit[0].value] = 0);
                            traits_map[outfit[0].value][outfit[0].value] += 1;
                            break;
                        case 2:
                            !traits_map[outfit[0].value].hasOwnProperty(`${outfit[0].value}-${outfit[1].value}`) && (traits_map[outfit[0].value][`${outfit[0].value}-${outfit[1].value}`] = 0);
                            traits_map[outfit[0].value][`${outfit[0].value}-${outfit[1].value}`] += 1;

                            if (outfit[0].value != outfit[1].value) {
                                !traits_map[outfit[1].value].hasOwnProperty(`${outfit[1].value}-${outfit[0].value}`) && (traits_map[outfit[1].value][`${outfit[1].value}-${outfit[0].value}`] = 0);
                                traits_map[outfit[1].value][`${outfit[1].value}-${outfit[0].value}`] += 1;
                            }
                            break;
                    };
                } catch (err) {
                    console.log('Rat trait mapping failed', rat);
                }
            };

            const build_and_fill_pie_chart = traits_map => {
                const serie_data = [];
                const drilldown_serie = [];

                for (const trait in traits_map) {
                    serie_data.push({
                        name: trait,
                        drilldown: trait,
                        y: sumArray(Object.values(traits_map[trait]))
                    });

                    const drilldown_data = [];

                    for (const couple in traits_map[trait]) {
                        drilldown_data.push([couple, traits_map[trait][couple]]);
                    }

                    drilldown_serie.push({
                        name: trait,
                        id: trait,
                        data: drilldown_data
                    });
                }

                return build_pie_chart(serie_data, drilldown_serie);
            };

            function sumArray(array) {
                let result = 0;

                for (const current of array) {
                    result += current;
                }

                return result;
            }

            function build_pie_chart(serie_data, drilldown_serie) {
                return Highcharts.chart('pie_chart_container', {
                    chart: {
                        type: 'pie'
                    },
                    title: {
                        text: 'TRAITS PAIRS - RARITY BASED'
                    },
                    subtitle: {
                        text: 'Click on a trait to see the pairs'
                    },

                    accessibility: {
                        announceNewData: {
                            enabled: true
                        },
                        point: {
                            valueSuffix: '#'
                        }
                    },

                    plotOptions: {
                        series: {
                            dataLabels: {
                                enabled: true,
                                format: '{point.name}: {point.y}'
                            }
                        }
                    },

                    tooltip: {
                        headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                        pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y}</b><br/>'
                    },

                    series: [{
                        name: "Traits",
                        colorByPoint: true,
                        data: serie_data || []
                    }],
                    drilldown: {
                        series: drilldown_serie
                    }
                });
            };
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>